--ADMIN
CREATE USER MDY2131_ET_FA
IDENTIFIED BY "123456ABcdef"
DEFAULT TABLESPACE DATA
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON DATA;

CREATE USER MDY2131_ET_FA_DES 
IDENTIFIED BY "123456ABcdef"
DEFAULT TABLESPACE DATA
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON DATA;

CREATE USER MDY2131_ET_FA_CON
IDENTIFIED BY "123456ABcdef"
DEFAULT TABLESPACE DATA
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON DATA;

--PRIVILEGIOS
GRANT CREATE SESSION,  
    CREATE TABLE, 
    ALTER ANY TABLE, 
    DROP ANY TABLE, 
    CREATE SEQUENCE, 
    CREATE ANY INDEX,
    CREATE SYNONYM
TO MDY2131_ET_FA;

GRANT CREATE SESSION, 
    CREATE PROCEDURE,
    CREATE TRIGGER,
    CREATE VIEW,
    CREATE MATERIALIZED VIEW
TO MDY2131_ET_FA_DES;

GRANT CREATE SESSION
TO MDY2131_ET_FA_CON;

CREATE ROLE ROL_SELECT;

--Synonym
DROP PUBLIC SYNONYM SYN_ATENCION;
CREATE PUBLIC SYNONYM SYN_ATENCION FOR MDY2131_ET_FA.ATENCION;

DROP PUBLIC SYNONYM SYN_MEDICO;
CREATE PUBLIC SYNONYM SYN_MEDICO FOR MDY2131_ET_FA.MEDICO;

DROP PUBLIC SYNONYM SYN_ESPECIALIDAD;
CREATE PUBLIC SYNONYM SYN_ESPECIALIDAD FOR MDY2131_ET_FA.ESPECIALIDAD;

DROP PUBLIC SYNONYM SYN_S;
CREATE PUBLIC SYNONYM SYN_S FOR MDY2131_ET_FA.SELECCION_ESPECIALIDAD;


GRANT SELECT ON SYN_ATENCION TO ROL_SELECT;
GRANT SELECT ON SYN_MEDICO TO ROL_SELECT;
GRANT SELECT ON SYN_ESPECIALIDAD TO ROL_SELECT;
GRANT SELECT, UPDATE, INSERT ON SYN_S TO ROL_SELECT;
GRANT ROL_SELECT TO MDY2131_ET_FA_CON, MDY2131_ET_FA_DES;

--INFORME 1 MDY2131_ET_FA_DES
CREATE OR REPLACE VIEW INFORME1
AS SELECT
    e.nombre AS "ESPECIALIDAD",
    COUNT(DISTINCT m.med_run) AS "CANTIDAD MEDICOS",
    COUNT(a.ate_id) AS "ATENCIONES",
    SUM(a.costo) AS "COSTO ATENCIONES",
    ROUND(AVG(a.costo)) AS "COSTO PROMEDIO ATENCIONES"
FROM SYN_ESPECIALIDAD e
INNER JOIN SYN_MEDICO m ON e.esp_id = m.esp_id
INNER JOIN SYN_ATENCION a ON a.med_run = m.med_run
WHERE a.fecha_atencion >= ADD_MONTHS(SYSDATE, -5)
GROUP BY e.nombre
ORDER BY COUNT(DISTINCT m.med_run) DESC;

SELECT * FROM INFORME1;

SELECT * FROM SYN_ATENCION





--INFORME 2
SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY') AS "FECHA_EMISION",
    e.esp_id AS "CODIGO ESPECIALIDAD",
    e.nombre AS "ESPECIALIDAD",
    ROUND(AVG(m.sueldo_base), 2)
    AS "SUELDO PROMEDIO MEDICOS",
    COUNT(m.med_run)
    AS "TOTAL MEDICOS"
FROM SYN_ESPECIALIDAD e
JOIN SYN_MEDICO M ON E.ESP_ID = M.ESP_ID
GROUP BY  e.esp_id, e.nombre
ORDER BY e.nombre ASC;



--INSERT DE SELECT
INSERT INTO SELECCION_ESPECIALIDAD
(FECHA,
ID_ESPECIALIDAD, 
ESPECIALIDAD, 
SUELDO_PROMEDIO, 
TOTAL_MEDICOS)

SELECT TO_CHAR(SYSDATE, 'DD/MM/YYYY') AS "FECHA EMISION",
    e.esp_id AS "CODIGO ESPECIALIDAD",
    e.nombre AS "ESPECIALIDAD",
    (SELECT ROUND(AVG(M.sueldo_base), 2)
     FROM SYN_MEDICO M 
     WHERE M.esp_id = e.esp_id) AS "SUELDO PROMEDIO MEDICOS",
    (SELECT COUNT(M.med_run)
     FROM SYN_MEDICO M 
     WHERE M.esp_id = e.esp_id) AS "TOTAL MEDICOS"
FROM SYN_ESPECIALIDAD E
ORDER BY e.nombre ASC;

